<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ژنراتور محتوای HTML پیشرفته</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

    <style id="base-styles">
        /* Base Styles */
        body { font-family: Tahoma, sans-serif; padding: 20px; background-color: #f4f4f4; margin: 0; }
        .main-container { display: flex; max-width: 1400px; margin: 0 auto; gap: 20px; }
        .controls { flex: 1; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .preview-area { flex: 2; min-height: 500px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; overflow-y: auto; }
        .output-actions { width: 100%; max-width: 1400px; margin: 20px auto; text-align: center; }

        /* Control Inputs & Buttons */
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .add-btn, .action-btn { padding: 10px 18px; margin-top: 20px; cursor: pointer; border: none; border-radius: 4px; color: white; transition: background-color 0.3s; }
        .add-btn { background-color: #007BFF; width: 100%; }
        .add-btn:hover { background-color: #0056b3; }
        .action-btn { margin: 0 5px; }

        /* Live Element Styles & Controls */
        .page-element { 
            padding: 15px; 
            margin-bottom: 10px; 
            border: 1px dashed #ccc; 
            background-color: #f9f9f9; 
            display: flex; 
            align-items: flex-start;
            justify-content: space-between;
        }
        .element-content { flex-grow: 1; margin-left: 10px; }
        .element-controls button { font-size: 12px; padding: 5px 10px; margin-bottom: 5px; display: block; background-color: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; }
        .element-controls .delete-btn { background-color: #dc3545; color: white; }
        
        /* Specific Element Styles (For Preview) */
        .card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card img { max-width: 100px; height: auto; float: right; margin-right: 15px; border-radius: 4px; }
        .card-body { overflow: hidden; }
        .spacer-preview { background-color: #e6e6e6; text-align: center; color: #666; font-size: 12px; line-height: 1; padding-top: 5px; border: 1px solid #ccc; }
        
        /* Modal for Link Sharing */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); 
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: right;
        }
        .modal-link-box {
            background: #f0f0f0; padding: 10px; border-radius: 5px; 
            overflow-x: auto; font-family: monospace; font-size: 14px;
            margin: 15px 0; border: 1px solid #ccc;
        }
        .copy-btn { background-color: #28a745; margin-top: 10px; margin-left: 10px; }
        .close-btn { background-color: #6c757d; margin-top: 10px; }

        /* Hiding specific controls based on selection */
        .hidden-control { display: none; }
    </style>
</head>
<body onload="loadFromLink()">

    <h1 id="main-title" style="text-align: center; margin-bottom: 30px;">ژنراتور محتوای HTML پیشرفته</h1>

    <div class="main-container" id="editor-container">
        <div class="controls">
            <h2>تنظیمات المان</h2>
            <label for="element-type">انتخاب نوع المان:</label>
            <select id="element-type" onchange="updateControls()">
                <option value="button">دکمه (Button)</option>
                <option value="input_field">جای وارد کردن متن (Input)</option>
                <option value="spacer">فاصله‌دهنده (Spacer)</option>
                <option value="title">عنوان (h2)</option>
                <option value="paragraph">پاراگراف</option>
                <option value="image">تصویر (Image)</option>
                <option value="video">ویدیوی Embed</option>
                <option value="table">جدول ساده</option>
                <option value="list">لیست بولت‌دار</option>
                <option value="card">کارت (Card)</option>
                <option value="file_link">لینک فایل یا دانلود</option>
            </select>
            
            <div id="common-controls">
                <label for="element-content" id="label-content">متن المان:</label>
                <textarea id="element-content">این یک دکمه است.</textarea>

                <label for="element-link" id="label-link">لینک (URL/آدرس):</label>
                <input type="text" id="element-link" placeholder="http://example.com/..." value="#">
            </div>

            <div id="style-controls">
                <h3 style="margin-top: 25px;">تنظیمات استایل و عملکرد</h3>

                <div id="button-styles" class="hidden-control">
                    <label for="color-main">رنگ اصلی دکمه:</label><input type="color" id="color-main" value="#007BFF">
                    <label for="color-hover">رنگ در هاور (Hover):</label><input type="color" id="color-hover" value="#0056b3">
                    <label for="color-text">رنگ متن دکمه:</label><input type="color" id="color-text" value="#FFFFFF">
                    <label for="button-action">عملکرد دکمه:</label>
                    <select id="button-action">
                        <option value="link">باز کردن لینک/صفحه</option>
                        <option value="alert">نمایش پیغام (Alert)</option>
                    </select>
                </div>

                <div id="input-controls" class="hidden-control">
                    <label for="input-placeholder">متن پیش‌فرض (Placeholder):</label>
                    <input type="text" id="input-placeholder" value="متن خود را وارد کنید...">
                </div>

                <div id="spacer-controls" class="hidden-control">
                    <label for="spacer-height">ارتفاع فاصله‌دهنده (px):</label>
                    <input type="number" id="spacer-height" value="30" min="5">
                </div>

                <div id="text-styles" class="hidden-control">
                    <label for="text-size">اندازه متن (فونت):</label>
                    <select id="text-size">
                        <option value="normal">متوسط (16px)</option>
                        <option value="large">بزرگ (20px)</option>
                        <option value="small">کوچک (14px)</option>
                    </select>
                    <label for="text-color">رنگ متن:</label><input type="color" id="text-color-value" value="#333333">
                </div>
                
                <div id="table-controls" class="hidden-control">
                    <label for="table-rows">تعداد سطر:</label><input type="number" id="table-rows" value="3" min="1">
                    <label for="table-cols">تعداد ستون:</label><input type="number" id="table-cols" value="2" min="1">
                    <p style="font-size: 12px; color: #666;">متن سلول‌ها را در پیش‌نمایش ویرایش کنید.</p>
                </div>
            </div>
            
            <button class="add-btn" onclick="addElement()">اضافه کردن المان به صفحه</button>
        </div>

        <div class="preview-area" id="live-preview">
            <h2 style="color: #666; margin-top: 0;">پیش‌نمایش زنده صفحه</h2>
        </div>
    </div>

    <div class="output-actions">
        <button class="action-btn" onclick="downloadHtml()" style="background-color: #28a745;">دانلود فایل HTML نهایی</button>
        <button class="action-btn" onclick="createShareableLink()" style="background-color: #ff9800;">ساخت لینک اشتراک‌گذاری (فشرده)</button>
        <button class="action-btn" onclick="clearContent()" style="background-color: #6c757d;">پاک کردن تمام محتوا</button>
    </div>

    <div id="content-viewer" style="display: none; padding: 0;">
        </div>
    
    <div id="link-modal" class="modal-overlay" onclick="hideModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-top: 0;">لینک اشتراک‌گذاری محتوا (فشرده شده)</h3>
            <p style="color: #888; font-size: 14px;">این لینک به دلیل فشرده‌سازی، نسبت به Base64 خام بسیار کوتاه‌تر است.</p>
            <div id="share-link-box" class="modal-link-box"></div>
            <button class="copy-btn" onclick="copyLink()">کپی کردن لینک</button>
            <button class="close-btn" onclick="hideModal()">بستن</button>
        </div>
    </div>

    <script>
        // --- متغیرها ---
        const livePreview = document.getElementById('live-preview');
        const spacerHeight = document.getElementById('spacer-height');
        const mainTitle = document.getElementById('main-title');
        const editorContainer = document.getElementById('editor-container');
        const outputActions = document.querySelector('.output-actions');
        const contentViewer = document.getElementById('content-viewer');

        // --- منطق نمایش/مخفی کردن کنترل‌ها و افزودن المان (بدون تغییر) ---
        // (این توابع طولانی برای سادگی نمایش حذف شده‌اند اما در کد کامل بالا هستند)

        function updateControls() {
            // منطق کنترل‌ها...
             const type = document.getElementById('element-type').value;
            
            document.querySelectorAll('#style-controls > div').forEach(div => div.classList.add('hidden-control'));
            document.getElementById('element-content').parentNode.style.display = 'block';
            document.getElementById('element-link').parentNode.style.display = 'block';

            if (type === 'button') {
                document.getElementById('button-styles').classList.remove('hidden-control');
            } else if (['title', 'paragraph', 'list'].includes(type)) {
                document.getElementById('text-styles').classList.remove('hidden-control');
            } else if (type === 'table') {
                document.getElementById('table-controls').classList.remove('hidden-control');
            } else if (type === 'input_field') {
                document.getElementById('input-controls').classList.remove('hidden-control');
                document.getElementById('element-content').parentNode.style.display = 'none';
                document.getElementById('element-link').parentNode.style.display = 'none';
            } else if (type === 'spacer') {
                document.getElementById('spacer-controls').classList.remove('hidden-control');
                document.getElementById('element-content').parentNode.style.display = 'none';
                document.getElementById('element-link').parentNode.style.display = 'none';
            }

            const labels = {
                'button': ['متن دکمه:', 'لینک مقصد:'],
                'input_field': ['نام فیلد (اختیاری):', ''],
                'spacer': ['', ''],
                'title': ['متن عنوان:', ''],
                'paragraph': ['متن پاراگراف:', ''],
                'image': ['متن جایگزین (Alt):', 'آدرس تصویر (URL):'],
                'video': ['عنوان ویدیو:', 'لینک یوتیوب/آپارات:'],
                'table': ['عنوان جدول:', ''],
                'list': ['آیتم‌های لیست (با خط جدید جدا کنید):', ''],
                'card': ['عنوان کارت:', 'آدرس تصویر کارت:'],
                'file_link': ['نام فایل:', 'لینک دانلود فایل:']
            };

            const linkNeeded = labels[type] && labels[type][1];
            const contentNeeded = labels[type] && labels[type][0];
            
            if (type !== 'spacer' && type !== 'input_field') {
                document.getElementById('label-content').textContent = contentNeeded;
                document.getElementById('label-link').textContent = linkNeeded;
                document.getElementById('element-link').parentNode.style.display = linkNeeded ? 'block' : 'none';
                document.getElementById('element-content').parentNode.style.display = contentNeeded ? 'block' : 'none';
            }
        }
        function addElement() { /*... */ }
        function updateHtmlData(elementWrapper) { /*... */ }
        function moveElement(element, direction) { /*... */ }
        function deleteElement(element) { /*... */ }
        function clearContent() { /*... */ }
        function getPageHtmlContent() { /*... */ 
             Array.from(document.querySelectorAll('.page-element')).forEach(updateHtmlData);
            
            const elements = Array.from(document.querySelectorAll('.page-element'));
            const contentToDownload = elements.map(el => {
                if (el.querySelector('.spacer-preview')) {
                     const height = el.querySelector('.spacer-preview').style.height.replace('px', '');
                     return `<div style="height: ${height}px;"></div>`;
                }
                return el.dataset.html;
            }).join('\n    ');

            return contentToDownload;
        }
        function downloadHtml() { /*... */ }

        // --- توابع فشرده‌سازی و رمزگذاری (LZString) ---

        function createShareableLink() {
            // مطمئن شوید که کتابخانه LZString بارگذاری شده است
            if (typeof LZString === 'undefined') {
                alert('خطا: کتابخانه LZString بارگذاری نشده است. لطفا اتصال اینترنت خود را بررسی کنید.');
                return;
            }
            
            const content = getPageHtmlContent();
            
            // 2. فشرده‌سازی و رمزگذاری برای استفاده در URL (بسیار کارآمدتر از Base64 خام)
            const compressedAndEncodedContent = LZString.compressToEncodedURIComponent(content);
            
            // ساخت لینک نهایی
            const baseUrl = window.location.origin + window.location.pathname;
            const shareableLink = baseUrl + '?data=' + compressedAndEncodedContent;

            // نمایش مودال لینک
            showLinkModal(shareableLink);
        }

        function loadFromLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const data = urlParams.get('data');

            if (data) {
                // مخفی کردن ویرایشگر و نمایش محتوا به صورت تمام صفحه
                mainTitle.style.display = 'none';
                editorContainer.style.display = 'none';
                outputActions.style.display = 'none';
                contentViewer.style.display = 'block';
                
                // تنظیم استایل بدنه برای نمایش تمام صفحه محتوا
                document.body.style.padding = '0';
                document.body.style.backgroundColor = '#fff';

                try {
                    // مطمئن شوید که کتابخانه LZString بارگذاری شده است
                    if (typeof LZString === 'undefined') {
                        contentViewer.innerHTML = `<p style="color: red; font-size: 18px; padding: 20px;">❌ خطا: کتابخانه LZString بارگذاری نشده است. لطفا اتصال اینترنت خود را بررسی کنید.</p>`;
                        return;
                    }
                    
                    // 2. رمزگشایی و بازگرداندن به حالت اولیه
                    const decodedContent = LZString.decompressFromEncodedURIComponent(data);
                    
                    if (!decodedContent) {
                        throw new Error('Decompression failed or data is corrupted.');
                    }
                    
                    contentViewer.innerHTML = `
                        <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
                            ${decodedContent}
                        </div>
                        <button onclick="window.location.href = window.location.pathname" style="
                            position: fixed; 
                            top: 15px; 
                            left: 15px; 
                            background-color: #f44336; 
                            color: white; 
                            border: none; 
                            padding: 8px 15px; 
                            border-radius: 4px; 
                            cursor: pointer; 
                            z-index: 9999;">
                            بازگشت به ویرایشگر
                        </button>
                    `;
                    
                    contentViewer.style.padding = '20px';


                } catch (e) {
                    contentViewer.innerHTML = `
                        <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
                            <p style="color: red; font-size: 18px;">❌ خطا در بارگذاری محتوا از لینک. (ممکن است لینک آسیب دیده یا بسیار طولانی بوده باشد)</p>
                        </div>
                        <button onclick="window.location.href = window.location.pathname" style="
                            position: fixed; top: 15px; left: 15px; background-color: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; z-index: 9999;">
                            بازگشت به ویرایشگر
                        </button>
                    `;
                    console.error("Error decoding data:", e);
                }
            } else {
                // حالت عادی: نمایش ویرایشگر
                mainTitle.style.display = 'block';
                editorContainer.style.display = 'flex';
                outputActions.style.display = 'block';
                contentViewer.style.display = 'none';
                document.body.style.padding = '20px';
                document.body.style.backgroundColor = '#f4f4f4';
            }
        }

        // --- توابع Modal Link (بدون تغییر) ---

        function showLinkModal(link) {
            const modal = document.getElementById('link-modal');
            const linkBox = document.getElementById('share-link-box');
            linkBox.textContent = link;
            modal.style.display = 'flex';
        }

        function hideModal(event) {
            const modal = document.getElementById('link-modal');
            if (!event || event.target === modal || event.target.className === 'close-btn') {
                modal.style.display = 'none';
            }
        }

        function copyLink() {
            const linkBox = document.getElementById('share-link-box');
            const range = document.createRange();
            range.selectNode(linkBox);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                document.execCommand('copy');
                const copyButton = document.querySelector('.copy-btn');
                copyButton.textContent = '✅ کپی شد!';
                copyButton.style.backgroundColor = '#17a2b8';
                
                setTimeout(() => {
                    copyButton.textContent = 'کپی کردن لینک';
                    copyButton.style.backgroundColor = '#28a745';
                }, 1500);

            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            window.getSelection().removeAllRanges();
        }
        
        // اجرای اولیه برای تنظیم کنترل‌ها
        updateControls();
    </script>
</body>
</html>
